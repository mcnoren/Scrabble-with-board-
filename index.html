<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scrabble Host</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        :root {
            --bg-color: #1a1a1a;
            --board-bg: #e6dac8;
            --tile-bg: #f8eeb2;
            --tile-dark: #d3c08e;
            --tw: #ff3838; --dw: #ff9f9f;
            --tl: #0984e3; --dl: #74b9ff;
            --active-player: #2ecc71;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Helvetica Neue', Arial, sans-serif; background: var(--bg-color); color: white; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* SCREENS */
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; position: absolute; top:0; left:0; background: var(--bg-color); z-index: 10; }
        .active { display: flex; z-index: 20; }

        /* BUTTONS & INPUTS */
        input { padding: 15px; font-size: 1.1rem; border-radius: 8px; border: 1px solid #555; background: #333; color: white; margin-bottom: 15px; text-transform: uppercase; text-align: center; }
        button { background: #2ecc71; color: white; border: none; padding: 15px 30px; font-size: 1.1rem; border-radius: 8px; cursor: pointer; margin: 5px; font-weight: bold; box-shadow: 0 4px 0 #27ae60; transition: transform 0.1s; touch-action: manipulation; }
        button:active { transform: translateY(4px); box-shadow: none; }
        button:disabled { background: #555; box-shadow: none; color: #888; cursor: not-allowed; }
        .btn-danger { background: #e74c3c; box-shadow: 0 4px 0 #c0392b; }
        .btn-blue { background: #3498db; box-shadow: 0 4px 0 #2980b9; }

        /* COMMON UI */
        .loading-text { color: #f1c40f; font-style: italic; font-size: 0.9rem; margin-top: 5px; }
        h1 { font-size: 2.5rem; margin-bottom: 20px; text-shadow: 2px 2px 0 #000; }

        /* TILE */
        .tile {
            width: 38px; height: 38px;
            background: var(--tile-bg);
            border-radius: 4px;
            box-shadow: 1px 1px 0 #bfa87a, 2px 2px 3px rgba(0,0,0,0.4);
            color: #222;
            display: flex; justify-content: center; align-items: center;
            font-weight: bold; font-size: 1.3rem;
            position: relative;
            user-select: none;
            cursor: grab;
            z-index: 100;
            touch-action: none; /* Crucial for custom drag */
        }
        .tile span.score { font-size: 0.6rem; position: absolute; bottom: 2px; right: 3px; font-weight: normal; }
        .tile.selected { outline: 3px solid #2ecc71; }
        .tile.dragging { opacity: 0.8; transform: scale(1.1); box-shadow: 0 10px 20px rgba(0,0,0,0.5); z-index: 9999; pointer-events: none; position: fixed; }

        /* HOST LAYOUT (iPad Optimized) */
        #host-ui { flex-direction: row; align-items: stretch; padding: 0; background: #222; }
        
        /* Left Sidebar: Info & Players */
        .sidebar { 
            width: 250px; background: #2c3e50; padding: 15px; 
            display: flex; flex-direction: column; border-right: 4px solid #1a252f;
            box-shadow: 5px 0 15px rgba(0,0,0,0.3); z-index: 30;
        }
        .turn-banner {
            background: #1a252f; padding: 15px; border-radius: 8px; margin-bottom: 20px;
            text-align: center; border: 2px solid #555;
        }
        .current-player-name { color: var(--active-player); font-size: 1.4rem; font-weight: bold; display: block; margin-top: 5px; }

        .player-list-container { flex-grow: 1; overflow-y: auto; }
        .player-card {
            background: rgba(255,255,255,0.05); padding: 10px; margin-bottom: 8px; border-radius: 4px;
            border-left: 4px solid transparent; display: flex; justify-content: space-between;
        }
        .player-card.active-turn { background: rgba(46, 204, 113, 0.2); border-left-color: var(--active-player); }
        .player-card .score { font-weight: bold; color: #f1c40f; }

        /* Main Board Area */
        .board-wrapper {
            flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: #333; position: relative; padding: 10px;
        }
        
        .scrabble-board {
            display: grid;
            grid-template-columns: repeat(15, 1fr);
            grid-template-rows: repeat(15, 1fr);
            gap: 2px;
            background: #000;
            border: 8px solid #5d4037;
            border-radius: 4px;
            /* Responsive Sizing for iPad */
            width: 95vmin; height: 95vmin;
            max-width: 650px; max-height: 650px;
        }

        .cell {
            background: var(--board-bg);
            display: flex; justify-content: center; align-items: center;
            font-size: 0.6rem; font-weight: bold; color: #444;
            position: relative;
        }
        .cell.tw { background: var(--tw); color: white; }
        .cell.dw { background: var(--dw); }
        .cell.tl { background: var(--tl); color: white; }
        .cell.dl { background: var(--dl); }
        .cell.star { background: var(--dw); }
        .cell.star::after { content: '★'; font-size: 1.5rem; color: white; }
        
        /* Ensure tile fits perfectly in cell */
        .cell .tile { width: 100%; height: 100%; margin: 0; box-shadow: none; border-radius: 0; }

        /* Host Controls (Bottom) */
        .host-controls {
            width: 100%; padding: 10px 20px; background: #222; border-top: 2px solid #444;
            display: flex; gap: 15px; align-items: center; justify-content: space-between;
        }
        .inbox-area {
            flex-grow: 1; display: flex; align-items: center; gap: 10px; 
            background: #111; padding: 5px 15px; border-radius: 8px; height: 60px;
        }
        .inbox-rack { display: flex; gap: 5px; overflow-x: auto; }

        /* PLAYER PHONE UI */
        #player-ui { background: #1e1e1e; justify-content: space-between; }
        .rack-container { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        .player-rack {
            background: #5d4037; padding: 20px; border-radius: 6px;
            display: flex; gap: 8px; box-shadow: inset 0 5px 10px rgba(0,0,0,0.5);
            min-height: 80px; min-width: 320px; justify-content: center;
        }
        /* Bigger tiles on phone */
        .player-rack .tile { width: 55px; height: 55px; font-size: 2rem; box-shadow: 0 4px 0 #3e2723; }

        .ghost { opacity: 0.4; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="screen-home" class="screen active">
        <h1>Scrabble Party</h1>
        <button onclick="initHost()" class="btn-blue">Host Board (iPad)</button>
        <button onclick="showJoin()">Join Game (Phone)</button>
        <div id="dict-status" class="loading-text">Dictionary: Not Loaded</div>
    </div>

    <div id="screen-lobby" class="screen">
        <h2>Lobby Code: <span id="lobby-code" style="color:var(--active-player)">...</span></h2>
        <div id="lobby-list" style="margin: 20px; width: 300px; text-align: left; background:#222; padding:10px;"></div>
        <button onclick="startGame()">Start Game</button>
    </div>

    <div id="screen-host" class="screen" id="host-ui">
        <div class="sidebar">
            <div class="turn-banner">
                <div style="font-size:0.8rem; color:#aaa; text-transform:uppercase;">Current Turn</div>
                <span id="turn-name" class="current-player-name">--</span>
            </div>
            <div style="font-size:0.8rem; color:#aaa; margin-bottom:5px;">PLAYERS</div>
            <div id="host-player-list" class="player-list-container"></div>
            
            <div style="margin-top:auto; font-size:0.8rem; color:#666; text-align:center;">
                Tiles Left: <span id="bag-count">100</span>
            </div>
        </div>

        <div class="board-wrapper">
            <div class="scrabble-board" id="board-grid"></div>
        </div>

        </div>
    <div id="host-bottom-bar" style="position:absolute; bottom:0; left:250px; right:0; background:#222; padding:10px; display:none; border-top:1px solid #444; z-index:50;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div class="inbox-area">
                <span style="color:#aaa; font-size:0.8rem; width:50px;">INBOX</span>
                <div id="host-inbox" class="inbox-rack"></div>
            </div>
            <button onclick="validateAndEndTurn()" class="btn-blue" style="padding:10px 20px; font-size:0.9rem;">Check & End Turn</button>
        </div>
    </div>


    <div id="screen-join" class="screen">
        <h2>Join Game</h2>
        <input type="text" id="p-name" placeholder="Nickname" maxlength="8">
        <input type="text" id="p-code" placeholder="Room Code">
        <button onclick="joinGame()">Enter</button>
        <button onclick="location.reload()" class="btn-danger">Back</button>
    </div>

    <div id="screen-player" class="screen" id="player-ui">
        <div style="padding:15px; width:100%; display:flex; justify-content:space-between; background:#111;">
            <span id="p-display-name" style="color:#2ecc71; font-weight:bold;">Player</span>
            <span style="color:#aaa; font-size:0.8rem;">Landscape Mode Rec.</span>
        </div>

        <div class="rack-container">
            <div id="my-rack" class="player-rack"></div>
        </div>

        <div style="padding:20px; width:100%; display:flex; gap:10px; background:#111;">
            <button onclick="shuffleRack()" style="flex:1; background:#f39c12">Shuffle</button>
            <button onclick="sendTiles()" style="flex:2; background:#2ecc71">Send Selected</button>
        </div>
    </div>

    <script>
        // --- CONFIG & DATA ---
        const SCORE_MAP = {
            'A':1,'B':3,'C':3,'D':2,'E':1,'F':4,'G':2,'H':4,'I':1,'J':8,'K':5,'L':1,'M':3,
            'N':1,'O':1,'P':3,'Q':10,'R':1,'S':1,'T':1,'U':1,'V':4,'W':4,'X':8,'Y':4,'Z':10,'_':0
        };
        const BAG_DIST = {
            'A':9,'B':2,'C':2,'D':4,'E':12,'F':2,'G':3,'H':2,'I':9,'J':1,'K':1,'L':4,'M':2,
            'N':6,'O':8,'P':2,'Q':1,'R':6,'S':4,'T':6,'U':4,'V':2,'W':2,'X':1,'Y':2,'Z':1,'_':2
        };
        // 0=Empty, 1=TW, 2=DW, 3=TL, 4=DL, 5=Star
        const BOARD_LAYOUT = [
            [1,0,0,4,0,0,0,1,0,0,0,4,0,0,1],
            [0,2,0,0,0,3,0,0,0,3,0,0,0,2,0],
            [0,0,2,0,0,0,4,0,4,0,0,0,2,0,0],
            [4,0,0,2,0,0,0,4,0,0,0,2,0,0,4],
            [0,0,0,0,2,0,0,0,0,0,2,0,0,0,0],
            [0,3,0,0,0,3,0,0,0,3,0,0,0,3,0],
            [0,0,4,0,0,0,4,0,4,0,0,0,4,0,0],
            [1,0,0,4,0,0,0,5,0,0,0,4,0,0,1],
            [0,0,4,0,0,0,4,0,4,0,0,0,4,0,0],
            [0,3,0,0,0,3,0,0,0,3,0,0,0,3,0],
            [0,0,0,0,2,0,0,0,0,0,2,0,0,0,0],
            [4,0,0,2,0,0,0,4,0,0,0,2,0,0,4],
            [0,0,2,0,0,0,4,0,4,0,0,0,2,0,0],
            [0,2,0,0,0,3,0,0,0,3,0,0,0,2,0],
            [1,0,0,4,0,0,0,1,0,0,0,4,0,0,1]
        ];

        let dictionary = new Set();
        let peer, conn;
        let connections = {}; // id -> conn
        let players = []; // Array of objects {id, name, score}
        let turnIndex = 0;
        let bag = [];
        
        // --- DICTIONARY LOADING ---
        // Using a common raw github source for TWL06 (Scrabble Dictionary)
        fetch('https://raw.githubusercontent.com/redbo/scrabble/master/dictionary.txt')
            .then(r => r.text())
            .then(text => {
                const words = text.toUpperCase().split(/\s+/);
                words.forEach(w => dictionary.add(w));
                document.getElementById('dict-status').innerText = "Dictionary: Loaded (" + dictionary.size + " words)";
                document.getElementById('dict-status').style.color = "#2ecc71";
            })
            .catch(e => {
                document.getElementById('dict-status').innerText = "Dictionary: Failed to load";
                console.error(e);
            });

        // --- HOST LOGIC ---
        function initHost() {
            peer = new Peer(generateId());
            peer.on('open', id => {
                showScreen('screen-lobby');
                document.getElementById('lobby-code').innerText = id;
                initBag();
            });
            peer.on('connection', c => {
                c.on('data', data => handleHostData(c, data));
                c.on('close', () => removePlayer(c.peer));
            });
        }

        function generateId() { return Math.random().toString(36).substr(2, 4).toUpperCase(); }

        function handleHostData(c, data) {
            if(data.type === 'join') {
                players.push({ id: c.peer, name: data.name, score: 0 });
                connections[c.peer] = c;
                updateLobby();
                // Send current board/state if joining mid-game could be added here
            } else if (data.type === 'play') {
                // Receive tiles into inbox
                data.tiles.forEach(l => addTileToInbox(l));
                // Deal replacement tiles immediately
                dealTiles(c, data.tiles.length);
            }
        }

        function updateLobby() {
            const list = document.getElementById('lobby-list');
            list.innerHTML = players.map(p => `<div>• ${p.name}</div>`).join('');
            
            // Also update sidebar list if game running
            const hostList = document.getElementById('host-player-list');
            hostList.innerHTML = '';
            players.forEach((p, idx) => {
                const div = document.createElement('div');
                div.className = `player-card ${idx === turnIndex ? 'active-turn' : ''}`;
                div.innerHTML = `<span>${p.name}</span><span class="score">${p.score}</span>`;
                hostList.appendChild(div);
            });
            
            // Update Header Name
            if(players.length > 0) {
                document.getElementById('turn-name').innerText = players[turnIndex].name;
            }
        }

        function startGame() {
            if(players.length === 0) return alert("Need players!");
            showScreen('screen-host');
            document.getElementById('host-bottom-bar').style.display = 'block';
            renderBoard();
            players.forEach(p => dealTiles(connections[p.id], 7));
            updateLobby(); // Update visual state
        }

        function initBag() {
            bag = [];
            for(let l in BAG_DIST) {
                for(let i=0; i<BAG_DIST[l]; i++) bag.push(l);
            }
            bag.sort(() => Math.random() - 0.5);
            document.getElementById('bag-count').innerText = bag.length;
        }

        function dealTiles(conn, num) {
            let hand = [];
            for(let i=0; i<num; i++) {
                if(bag.length) hand.push(bag.pop());
            }
            conn.send({ type: 'hand', tiles: hand });
            document.getElementById('bag-count').innerText = bag.length;
        }

        // --- BOARD & DRAG LOGIC (POINTER EVENTS FOR IPAD) ---
        let dragItem = null;
        let dragClone = null;
        let touchOffsetX = 0, touchOffsetY = 0;

        function renderBoard() {
            const grid = document.getElementById('board-grid');
            grid.innerHTML = '';
            for(let r=0; r<15; r++) {
                for(let c=0; c<15; c++) {
                    const d = document.createElement('div');
                    d.className = 'cell';
                    d.dataset.r = r; 
                    d.dataset.c = c;
                    
                    const type = BOARD_LAYOUT[r][c];
                    if(type === 1) { d.classList.add('tw'); d.innerText='TW'; }
                    if(type === 2) { d.classList.add('dw'); d.innerText='DW'; }
                    if(type === 3) { d.classList.add('tl'); d.innerText='TL'; }
                    if(type === 4) { d.classList.add('dl'); d.innerText='DL'; }
                    if(type === 5) { d.classList.add('star'); }
                    
                    grid.appendChild(d);
                }
            }
        }

        function createHostTile(letter) {
            const t = document.createElement('div');
            t.className = 'tile';
            t.dataset.letter = letter;
            t.innerHTML = `${letter === '_' ? '' : letter}<span class="score">${SCORE_MAP[letter]}</span>`;
            
            // ATTACH POINTER EVENTS
            t.addEventListener('pointerdown', onPointerDown);
            return t;
        }

        function addTileToInbox(letter) {
            document.getElementById('host-inbox').appendChild(createHostTile(letter));
        }

        // --- DRAG IMPLEMENTATION ---
        function onPointerDown(e) {
            e.preventDefault(); // Prevent scrolling
            dragItem = e.currentTarget;
            
            // Create a clone for visual dragging
            dragClone = dragItem.cloneNode(true);
            dragClone.classList.add('dragging');
            dragClone.style.width = dragItem.offsetWidth + 'px';
            dragClone.style.height = dragItem.offsetHeight + 'px';
            document.body.appendChild(dragClone);

            const rect = dragItem.getBoundingClientRect();
            touchOffsetX = e.clientX - rect.left;
            touchOffsetY = e.clientY - rect.top;

            moveClone(e.clientX, e.clientY);

            dragItem.style.opacity = '0'; // Hide original
            
            document.addEventListener('pointermove', onPointerMove);
            document.addEventListener('pointerup', onPointerUp);
        }

        function onPointerMove(e) {
            e.preventDefault();
            if(dragClone) moveClone(e.clientX, e.clientY);
        }

        function onPointerUp(e) {
            document.removeEventListener('pointermove', onPointerMove);
            document.removeEventListener('pointerup', onPointerUp);
            
            if(!dragClone) return;

            // Hide clone to check element below
            dragClone.hidden = true; 
            const elemBelow = document.elementFromPoint(e.clientX, e.clientY);
            dragClone.hidden = false;

            const cell = elemBelow ? elemBelow.closest('.cell') : null;
            const inbox = elemBelow ? elemBelow.closest('.inbox-area') : null;

            if (cell && !cell.hasChildNodes()) {
                // Drop in cell
                cell.appendChild(dragItem);
                dragItem.style.opacity = '1';
                cell.innerText = ''; // Clear board text (TW/DL etc)
                cell.classList.remove('tw','dw','tl','dl','star');
            } else if (inbox) {
                // Return to inbox
                document.getElementById('host-inbox').appendChild(dragItem);
                dragItem.style.opacity = '1';
            } else {
                // Revert
                dragItem.style.opacity = '1';
            }

            dragClone.remove();
            dragClone = null;
            dragItem = null;
        }

        function moveClone(x, y) {
            dragClone.style.left = (x - touchOffsetX) + 'px';
            dragClone.style.top = (y - touchOffsetY) + 'px';
        }

        // --- VALIDATION & TURN LOGIC ---
        function validateAndEndTurn() {
            if(dictionary.size === 0) {
                if(!confirm("Dictionary not loaded yet. Verify manually?")) return;
            }

            const grid = getBoardState();
            const words = findNewWords(grid);

            if (words.length === 0) {
                alert("No words formed.");
                return;
            }

            const invalid = words.filter(w => !dictionary.has(w) && dictionary.size > 0);
            
            if(invalid.length > 0) {
                alert("Invalid Words: " + invalid.join(", "));
                // Ideally, revert logic would be here, but for this simple version, we let host fix it manually
                return;
            }

            // Success
            alert(`Valid! Words: ${words.join(', ')}. Next turn.`);
            nextTurn();
        }

        function getBoardState() {
            // Returns 15x15 array of chars or null
            let state = [];
            const cells = document.querySelectorAll('.cell');
            cells.forEach(c => {
                const r = parseInt(c.dataset.r);
                const col = parseInt(c.dataset.c);
                if(!state[r]) state[r] = [];
                const tile = c.querySelector('.tile');
                state[r][col] = tile ? tile.dataset.letter : null;
            });
            return state;
        }

        function findNewWords(grid) {
            // Simplified scanner: just finds all sequences > 1 char
            let words = [];
            
            // Horizontal
            for(let r=0; r<15; r++) {
                let s = "";
                for(let c=0; c<15; c++) {
                    if(grid[r][c]) s += grid[r][c];
                    else { if(s.length > 1) words.push(s); s = ""; }
                }
                if(s.length > 1) words.push(s);
            }

            // Vertical
            for(let c=0; c<15; c++) {
                let s = "";
                for(let r=0; r<15; r++) {
                    if(grid[r][c]) s += grid[r][c];
                    else { if(s.length > 1) words.push(s); s = ""; }
                }
                if(s.length > 1) words.push(s);
            }
            return words;
        }

        function nextTurn() {
            turnIndex = (turnIndex + 1) % players.length;
            updateLobby(); // Refreshes sidebar highlight
        }

        // --- PLAYER PHONE LOGIC ---
        function showJoin() { showScreen('screen-join'); }

        function joinGame() {
            const name = document.getElementById('p-name').value;
            const code = document.getElementById('p-code').value.toUpperCase();
            if(!name || !code) return alert("Enter info");
            
            peer = new Peer();
            peer.on('open', () => {
                conn = peer.connect(code);
                conn.on('open', () => {
                    conn.send({ type: 'join', name: name });
                    showScreen('screen-player');
                    document.getElementById('p-display-name').innerText = name;
                    initRackSortable();
                });
                conn.on('data', d => {
                    if(d.type === 'hand') renderPlayerRack(d.tiles);
                });
            });
        }

        function initRackSortable() {
            Sortable.create(document.getElementById('my-rack'), {
                animation: 200, ghostClass: 'ghost'
            });
        }

        function renderPlayerRack(tiles) {
            const rack = document.getElementById('my-rack');
            tiles.forEach(l => {
                const d = document.createElement('div');
                d.className = 'tile';
                d.dataset.letter = l;
                d.innerHTML = `${l}<span class="score">${SCORE_MAP[l]}</span>`;
                d.onclick = () => d.classList.toggle('selected');
                rack.appendChild(d);
            });
        }

        function sendTiles() {
            const rack = document.getElementById('my-rack');
            const selected = rack.querySelectorAll('.tile.selected');
            if(!selected.length) return;
            
            const toSend = [];
            selected.forEach(el => {
                toSend.push(el.dataset.letter);
                el.remove();
            });
            
            conn.send({ type: 'play', tiles: toSend });
        }

        function shuffleRack() {
            const rack = document.getElementById('my-rack');
            const nodes = Array.from(rack.children);
            if(!nodes.length) return;
            for (let i = nodes.length; i >= 0; i--) {
                rack.appendChild(nodes[Math.random() * i | 0]);
            }
        }

        // Helper
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

    </script>
</body>
</html>
